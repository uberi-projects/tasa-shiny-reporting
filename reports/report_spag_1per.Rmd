---
output:
  officedown::rdocx_document:
    reference_docx: report_template.docx
    tables:
      style: table_template
params:
  release: "Unknown"
  user_name: "Unknown"
  datafile: pressure
  datafile_name: "Unknown"
  spag_1per_spag_season_selection: "None"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# Load packages ---------------------------
library(knitr)
library(officedown)
library(rmarkdown)
library(tidyverse)
library(ggpubr)

# Source code  ---------------------------
source("theme.r")
source("map.r")

# Filter to season
df <- params$datafile[[1]]
df$Date <- as.Date(df$Date)
if (as.character(params$spag_1per_spag_season_selection) != "None") {
  season_years <- unlist(strsplit(params$spag_1per_spag_season_selection, "-"))
  start_date <- as.Date(paste0(season_years[1], "-12-01"))
  end_date <- as.Date(paste0(season_years[2], "-05-31"))
  df <- df |>
    filter(Date >= start_date, Date <= end_date)
}
# Add month column  ---------------------------
df$Month <- format(df$Date, "%b %Y")

# Define study timeframe ---------------------------
study_start <- min(df$Date, na.rm = TRUE)
study_end   <- max(df$Date, na.rm = TRUE)
start_year <- as.integer(format(study_start, "%Y"))
end_year   <- as.integer(format(study_end, "%Y"))
if (format(study_start, "%m") %in% sprintf("%02d", 1:5) &&
    !any(format(df$Date, "%m") == "12")) {
  start_year <- start_year - 1
}
study_timeframe <- paste0(start_year, "-", end_year)
study_start <- min(df$Date, na.rm = TRUE)
study_year <- format(study_start, "%Y")
```

# Turneffe Atoll Spawning Aggregations Dataset Report: `r study_timeframe`


Turneffe Atoll Sustainability Association (TASA)


**Date Generated:** `r format(Sys.time(), '%Y-%m-%d')` \
**Source Data:** `r params$datafile_name` \
**Generated by:** `r params$user_name`\
**App Version:** `r params$release`\

***

The health and stability of fisheries is a key metric for ecological and 
economic well-being of a marine ecosystem. In Belize, 
commercially important reef fish reproduce in spawning aggregations (SPAGs), 
which indicate the success of the fisheries and provide opportunities for fishers 
to exploit the aggregations for high yields. This can cause depletions in 
SPAGs which harm the viability of commercially and ecologically important fish populations. 
This report presents findings from SPAGs monitoring at 
Turneffe Atoll Marine Reserve (TAMR) from `r study_timeframe`. 
his report aims to summarize and visualize the SPAG dataset from `r study_timeframe` 
to facilitate data interpretation and support sustainable fisheries and evidence-based 
management decisions by TASA staff, collaborators, and stakeholders.\


## Background

### Turneffe Atoll Marine Reserve

Turneffe Atoll is the largest atoll in Belize, spanning mangrove and littoral forest cayes, seagrass beds, and coral reef ecosystems (Stoddart, 1962). 
It features an inner lagoon as well as an outer reef that encircles the atoll. 
The Turneffe Atoll Marine Reserve (TAMR), which encompasses the entire atoll, covers 1,471 km² and includes multiple management zones, such as general use, conservation, preservation, and spawning aggregation zones, as well as special management areas. 
TAMR plays a valuable role in supporting biodiversity and sustaining the communities that depend on its resources. 
Its reef provides coastal protection from extreme weather events (Fedler, 2011), serves as a habitat for diverse marine species, and supports economic activities such as commercial and recreational fishing, guided diving, and tourism.\

### Spawning Aggregations Monitoring

SPAGs monitoring has been ongoing at TAMR since the 2022-2023 spawning season, 
with the aim of advancing sustainable fisheries management by showing how 
monitoring SPAGs can strengthen Belize's adaptive multispecies finfish management plan. 
Since then, SPAGs monitoring has continued each spawning season.

A risk with SPAGs is that they may become targets for fishers, who can obtain 
high yields through the aggregations. However, this may lead to depletions in 
which the population of the spawning fish can not replace itself or the aggregation 
can no longer form (Van Overzee & Rijnsdorp, 2015). 

Good management decisions, based on real data from SPAGs, can allow for timely 
interventions where necessary and support healthy, sustainable fisheries.\


## Methods

SPAGs data were collected at Turneffe Atoll 
Marine Reserve (TAMR) (Figure 1). 
The survey period for this report’s dataset extended 
from `r study_start` to `r study_end` at TAMR.


```{r figure1, echo = FALSE, fig.width = 7, fig.height = 7}
# Create map for Figure 1 ---------------------------
df_map <- df |>
  select(Site, Latitude, Longitude) |>
  distinct() |>
  na.omit()
if (study_year >= 2024) {
generate_map(df_map, "Latitude", "Longitude", "Site")
} else{
  generate_map_historic(df_map, "Latitude", "Longitude", "Site")
}
```

*Figure 1.* Map of Turneffe Atoll Marine Reserve zones and ecosystems. 
Shapefiles for zones belong to the Belize Fisheries Department (Belize Geomatics 2022). 
Shapefiles for the base map and ecosystems come from the publicly available Spatial Data 
Warehouse for Belize (Meerman 2013, Meerman 2017).
Waypoints for SPAG dives recorded in `r study_timeframe` are labelled on the map.\

Dive surveys were conducted by trained dive teams that followed standardized survey protocol at 
each Turneffe Atoll SPAG site. Dive timings were chosen to align with 
anticipated spawning events, which are associated with the full moon. 
For each dive, the GPS coordinates of the dive, start and end time of the dive, 
surface conditions, and underwater conditions were recorded. 
Next, species counts were taken, with observed fish species being counted and categorized into 
standardized size classes where it was possible to do so accurately. Otherwise, 
raw counts were simply taken without size differentiation. 
Behaviors indicative of spawning activity, including grouping, fighting, 
color changes, bite wounds, gravid individuals, courtship, and observed spawning, were also recorded. 

During the visual counts, Nassau groupers and other select fish species were additionally measured 
using laser sizing methodology, to acquire a more accurate measurement of length. The laser 
system comprised of two waterproof, dive-rated red lasers which were attached to 
a metal camera mounting frame. The lasers were configured to be set parallel to each other and aligned, 
with an exactly 12cm separation and a camera affixed to the top of the frame. 
During laser sizing, the lasers followed the 
lateral line of the fish as they swam by at approximately 5 to 6 meters away, 
and their movements were recorded via video. After the fieldwork, the videos were 
reviewed and the laser points were used to establish the scale for extrapolating the total lengths 
of the target fish. 

For a complete, detailed description of the methodology, please refer to the 
Reef Fish Spawning Aggregation Monitoring Protocol for the Meso-American Reef and the Wider Caribbean, 
Version 2.0 (2004).

This report, including text, figures, and tables, was generated using the 
Turneffe Reef-Monitoring Data Reporting Tool (TASA 2025, version `r params$release`), an R Shiny app which takes 
standardized reef monitoring data, validates the dataset, and creates a shareable output. \

## Results

```{r df, echo = FALSE, fig.width = 7, fig.height = 7}
# Create merged df for results ---------------------------
df_spec <- params$datafile[[2]]
df_laser <- params$datafile[[3]]
df_fish <- params$datafile[[4]]
df_spec_merged <- df_spec |>
  left_join(df, by = c("Season", "Dive")) |>
  filter(Site != "" & !is.na(Site)) |>
  left_join(df_fish, by = c("Species English Name" = "Common Name")) |>
  left_join(df_fish,   by = c("Species English Name" = "Alternative Common Name")) |>
  filter((`Scientific Name.x` != "" & !is.na(`Scientific Name.x`)) | (`Scientific Name.y` != "" & !is.na(`Scientific Name.y`)))
df_laser_merged <- df_laser |>
  left_join(df, by = c("Season", "Dive"))  |>
  filter(`Team Leader` != "" & !is.na(`Team Leader`)) 

```

```{r table1_prep, echo = FALSE, fig.width = 7, fig.height = 7}
table1_separate <- df_spec_merged |>
  group_by(Site) |>
  mutate(`Total Count` = as.numeric(`Total Count`)) |>
  summarise(
    Fish = sum(`Total Count`, na.omit = TRUE),
    Species = length(unique(`Species English Name`)),
    Dives = length(unique(Dive)),
    `Fish per Dive` = round(Fish/Dives)
    )
table1_overall <- df_spec_merged |>
  mutate(Site = "Overall") |>
  group_by(Site) |>
  mutate(`Total Count` = as.numeric(`Total Count`)) |>
  summarise(
    Fish = sum(`Total Count`, na.omit = TRUE),
    Species = length(unique(`Species English Name`)),
    Dives = length(unique(Dive)),
    `Fish per Dive` = round(Fish/Dives)
    )
table1 <- bind_rows(table1_separate, table1_overall)
total_fish <- format(table1_overall$Fish, big.mark = ",", scientific = FALSE)
total_fish_num <- sum(as.numeric(table1_overall$Fish), na.rm = TRUE)
total_species <- table1_overall$Species
total_sites <- nrow(table1_separate)
total_dives <- table1_overall$Dives
```

```{r table2_prep, echo = FALSE, fig.width = 7, fig.height = 7}
table2 <- df_spec_merged |>
  group_by(`Species English Name`) |>
  mutate(`Total Count` = as.numeric(`Total Count`)) |>
  summarise(
    Count = sum(`Total Count`, na.omit = TRUE),
    Proportion = round(Count/total_fish_num, 2),
    `Dives Found On` = length(unique(Dive))
  ) |>
  arrange(desc(Count)) |>
  slice_head(n = 10)
species_1 <- table2$`Species English Name`[1]
count_1 <- table2$Count[1]
prop_1 <- table2$Proportion[1]*100
species_2 <- table2$`Species English Name`[2]
count_2 <- table2$Count[2]
prop_2 <- table2$Proportion[2]*100
species_3 <- table2$`Species English Name`[3]
count_3 <- table2$Count[3]
prop_3 <- table2$Proportion[3]*100
most_dives <- table2$`Species English Name`[which.max(table2$`Dives Found On`)]
most_dives_num <- table2$`Dives Found On`[which.max(table2$`Dives Found On`)]

```


In total, `r total_fish` fish of `r total_species` unique species were observed in 
`r study_timeframe` across `r total_sites` sites and `r total_dives` dives (Table 1; Figure 2). 
The most observed fish species were `r species_1` (`r count_1` individuals; `r prop_1`%), 
`r species_2` (`r count_2` individuals; `r prop_2`%), 
and `r species_3` (`r count_3` individuals; `r prop_3`%). 
The fish species found on the most unique dives was `r most_dives` (`r most_dives_num` dives) (Table 2; Figure 2).


**Table 1.** Summary of SPAG monitoring by site and overall, including total fish observed, 
number of unique species observed, number of survey dives, 
and the average number of fish observed per dive. 
Data were collected using SPAG data from Turneffe Atoll Marine Reserve, `r study_timeframe`.\


```{r table1, echo = FALSE, fig.width = 7, fig.height = 7}
table1
```


```{r figure2, echo = FALSE, fig.width = 7, fig.height = 4.5}
df_fig2 <- df_spec_merged %>%
  group_by(Site, `Species English Name`) %>%
  summarise(Count = sum(as.numeric(`Total Count`), na.rm = TRUE))
ggplot(df_fig2, aes(x = `Species English Name`, y = Count, fill = Site)) +
  geom_col()+
  theme_custom +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  xlab("Species") +
    scale_fill_manual(values = palette[2:8])

```

*Figure 2.* Bar plot of observed fish species counts, colored by study site,  
and recorded during spawning aggregations at Turneffe 
Atoll Marine Reserve, `r study_timeframe`.\


**Table 2.** Summary of SPAG monitoring by species, including how many of that fish were observed, 
the proportion of overall fish that were that species, 
and the number of unique dives that the fish species was found on. 
Data were collected using SPAG data from Turneffe Atoll Marine Reserve, `r study_timeframe`.\

```{r table2, echo = FALSE, fig.width = 7, fig.height = 7}
table2
```



```{r figure3, echo = FALSE, fig.width = 7, fig.height = 4.5}
df_fig3 <- df_spec_merged %>%
  group_by(Site, Family.x) %>%
  summarise(Count = sum(as.numeric(`Total Count`), na.rm = TRUE))
ggplot(df_fig3, aes(x = Family.x, y = Count, fill = Site)) +
  geom_col()+
  theme_custom +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  xlab("Fish Family") +
    scale_fill_manual(values = palette[2:8])

```

*Figure 3.* Bar plot of observed fish family counts, colored by study site, 
and recorded during spawning aggregations at Turneffe 
Atoll Marine Reserve, `r study_timeframe`.\


```{r figure4, echo = FALSE, fig.width = 7, fig.height = 4.5}
df_fig4 <- df_spec_merged %>%
  select(
  `Species English Name`, `10-20 cm`,	`21-30 cm`,	`31-40 cm`,	`41-50 cm`,	
  `51-60 cm`,	`61-70 cm`,	`71-80 cm`, `81-90 cm`,	`91-100 cm`,	`101-110 cm`,	
  `111-120 cm`,	`121-130 cm`,	`> 130 cm`
  ) %>%
  mutate(across(-`Species English Name`, as.numeric)) %>%
  pivot_longer(
    cols = c(`10-20 cm`,	`21-30 cm`,	`31-40 cm`,	`41-50 cm`,	
  `51-60 cm`,	`61-70 cm`,	`71-80 cm`, `81-90 cm`,	`91-100 cm`,	`101-110 cm`,	
  `111-120 cm`,	`121-130 cm`,	`> 130 cm`),
  names_to = "Class", values_to = "Number"
  ) %>%
  filter(!is.na(Number) & Number > 0)%>%
  uncount(Number)  %>%
  mutate(
    Class = case_when(
      Class == "10-20 cm"  ~ 15,
      Class == "21-30 cm"  ~ 25,
      Class == "31-40 cm"  ~ 35,
      Class == "41-50 cm"  ~ 45,
      Class == "51-60 cm"  ~ 55,
      Class == "61-70 cm"  ~ 65,
      Class == "71-80 cm"  ~ 75,
      Class == "81-90 cm"  ~ 85,
      Class == "91-100 cm" ~ 95,
      Class == "101-110 cm"~ 105,
      Class == "111-120 cm"~ 115,
      Class == "121-130 cm"~ 125,
      Class == "> 130 cm"  ~ 135
    )
  ) %>%
  add_count(`Species English Name`, name = "Total") %>%
  filter(Total >= 10)  

ggplot(df_fig4, aes(x = `Species English Name`, y = Class)) +
  geom_violin()+
  theme_custom +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  xlab("Species") +
  ylab("Size Class") +
  scale_y_continuous(
    breaks = c(15, 25, 35, 45, 55, 65, 75, 85, 95, 105, 115, 125, 135),
    labels = c("10-20 cm", "21-30 cm", "31-40 cm", "41-50 cm",
               "51-60 cm", "61-70 cm", "71-80 cm", "81-90 cm",
               "91-100 cm", "101-110 cm", "111-120 cm", "121-130 cm",
               "> 130 cm")
  )

```


*Figure 4.* Violin plot of recorded size classes for fish, 
recorded during spawning aggregations visual surveys at Turneffe 
Atoll Marine Reserve, `r study_timeframe`. Fish species with fewer than 
observations of size class were excluded, and kernel densities were 
calculated using the midpoints of size classes.\


```{r figure5, echo = FALSE, fig.width = 7, fig.height = 6}
df_fig5 <- df_laser_merged %>%
  mutate(`Fish Measurement (cm)` = as.numeric(`Fish Measurement (cm)`))
top_species <- df_fig5 %>%
  count(Species) %>%
  arrange(desc(n)) %>%
  slice_head(n = 6) %>%
  pull(Species)
df_fig5 <- df_fig5 %>%
  filter(Species %in% top_species)
fig5A <- ggplot(df_fig5, aes(x = `Fish Measurement (cm)`, fill = Species)) +
  geom_histogram(binwidth = 1, color = "black", position = "identity") +
  theme_custom +
  ylab("Count") +
  labs(title = "A") +
  scale_x_continuous(breaks = seq(0, 120, by = 5)) +
  scale_fill_manual(values = palette) 
fig5B <- ggplot(df_fig5, aes(x = `Fish Measurement (cm)`, fill = Species)) +
  geom_density(aes(y = ..count.., color = Species), size = 1, fill = "transparent") +
  theme_custom +
  ylab("Count") +
 labs(title = "B") +
  scale_x_continuous(breaks = seq(0, 120, by = 5)) +
  scale_color_manual(values = palette) +
  theme(legend.position = "none")
ggarrange(fig5A, fig5B, nrow = 2, ncol = 1)

```

*Figure 5.* Length-frequency distributions of key fish, as both a histogram (A) 
and density curve (B), recorded during spawning aggregations laser sizing at Turneffe 
Atoll Marine Reserve, `r study_timeframe`. Only the six fish species with the 
most laser sizing data are shown. \


```{r figure6, echo = FALSE, fig.width = 7, fig.height = 4.5}
df_fig6 <- df_spec_merged %>%
  select(
    `Species English Name`, Site,
    `Grouping (1=yes)`, `Fighting (1=yes)`, `Color Changes (1=yes)`,
    `Bite Wounds (1=yes)`, `Gravid (1=yes)`, `Courtship (1=yes)`, `Spawning (1=yes)`
  ) %>%
  mutate(across(
    c(`Grouping (1=yes)`, `Fighting (1=yes)`, `Color Changes (1=yes)`,
      `Bite Wounds (1=yes)`, `Gravid (1=yes)`, `Courtship (1=yes)`, `Spawning (1=yes)`),
    as.numeric
  )) %>%
  pivot_longer(
    cols = c(`Grouping (1=yes)`, `Fighting (1=yes)`, `Color Changes (1=yes)`,
             `Bite Wounds (1=yes)`, `Gravid (1=yes)`, `Courtship (1=yes)`,
             `Spawning (1=yes)`),
    names_to = "Behavior", values_to = "Number"
  ) %>%
  group_by(Site, Behavior) %>%
  summarise(Count = sum(Number, na.rm = TRUE), .groups = "drop")%>%
  mutate(Behavior = str_remove(Behavior, " \\(1=yes\\)"))

ggplot(df_fig6, aes(x = Behavior, y = Site, fill = Count)) +
  geom_tile() +
    scale_fill_gradient(low = "white", high = palette[2]) +
  theme_custom

```

*Figure 6.* Tile plot of observed fish spawning behaviors, recorded during spawning aggregations 
visual surveys at Turneffe Atoll Marine Reserve, `r study_timeframe`.\


## Conclusion

By summarizing and visualizing the SPAG data from `r study_timeframe`, 
researchers, policy-makers, and other stakeholders are better able to interpret and use the dataset. 
This report supports the aims of the SPAG data collection by offering a more understandable view 
of the data itself, supporting future efforts to create recommendations on enforcement, monitoring, 
education, outreach, and regulations to ensure the long-term sustainability of the TAMR fishery while safeguarding the 
ecological value of the atoll.\


## Acknowledgments

Thank you to all team leaders, data collectors, and captains who participated in this project.\


## Literature Cited

Fedler, A. J. (2011). The Economic Value of Turneffe Atoll (Full Report). Turneffe Atoll Trust. http://www.turneffeatollmarinereserve.org/app/webroot/userfiles/214/File/Turneffe%20Atoll%20Valuation%20Study%20PDF%20-%20Final%20Report.pdf

Reef Fish Spawning Aggregation Monitoring Protocol for the Meso-American Reef and the Wider Caribbean, Version 2.0. (2004). https://reefresilience.org/pdf/Spawning_Aggregation_Monitoring_Protocol_4July2004.pdf

Stoddart, D. R. (1962). Three Caribbean atolls: Turneffe Islands, Lighthouse Reef and Glover’s Reef,  British Honduras. Atoll Research Bulletin, 87, 1–151.

Van Overzee, H. M. J., & Rijnsdorp, A. D. (2015). Effects of fishing during the spawning period: Implications for sustainable management. Reviews in Fish Biology and Fisheries, 25(1), 65–83. https://doi.org/10.1007/s11160-014-9370-x
