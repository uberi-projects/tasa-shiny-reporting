---
output:
  officedown::rdocx_document:
    reference_docx: report_template.docx
    tables:
      style: table_template
params:
  release: "Unknown"
  user_name: "Unknown"
  datafile: pressure
  datafile_name: "Unknown"
  spag_1per_spag_season_selection: "None"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# Load packages ---------------------------
library(knitr)
library(officedown)
library(rmarkdown)
library(tidyverse)
library(ggpubr)

# Source code  ---------------------------
source("theme.r")
source("map.r")

# Filter to season
df <- params$datafile[[1]]
df$Date <- as.Date(df$Date)
if (as.character(params$spag_1per_spag_season_selection) != "None") {
  season_years <- unlist(strsplit(params$spag_1per_spag_season_selection, "-"))
  start_date <- as.Date(paste0(season_years[1], "-12-01"))
  end_date <- as.Date(paste0(season_years[2], "-05-31"))
  df <- df |>
    filter(Date >= start_date, Date <= end_date)
}
# Add month column  ---------------------------
df$Month <- format(df$Date, "%b %Y")

# Define study timeframe ---------------------------
study_start <- min(df$Date, na.rm = TRUE)
study_end   <- max(df$Date, na.rm = TRUE)
start_year <- as.integer(format(study_start, "%Y"))
end_year   <- as.integer(format(study_end, "%Y"))
if (format(study_start, "%m") %in% sprintf("%02d", 1:5) &&
    !any(format(df$Date, "%m") == "12")) {
  start_year <- start_year - 1
}
study_timeframe <- paste0(start_year, "-", end_year)
study_start <- min(df$Date, na.rm = TRUE)
study_year <- format(study_start, "%Y")
```

# Turneffe Atoll Spawning Aggregations Dataset Report: `r study_timeframe`


Turneffe Atoll Sustainability Association (TASA)


***

The health and stability of fisheries is a key metric for ecological and 
economic well-being of a marine ecosystem. In Belize, 
commercially important reef fish reproduce in spawning aggregations (SPAGs), 
which indicate the success of the fisheries and provide opportunities for fishers 
to exploit the aggregations for high yields. This can cause depletions in 
SPAGs which harm the viability of commercially and ecologically important fish populations. 
This report presents findings from SPAGs monitoring at 
Turneffe Atoll Marine Reserve (TAMR) from `r study_timeframe`. 
his report aims to summarize and visualize the SPAG dataset from `r study_timeframe` 
to facilitate data interpretation and support sustainable fisheries and evidence-based 
management decisions by TASA staff, collaborators, and stakeholders.\


## Background

### Turneffe Atoll Marine Reserve

Turneffe Atoll is the largest atoll in Belize, encompassing mangrove and littoral forest cayes, seagrass beds, and extensive coral reef ecosystems (Stoddart, 1962). 
It features an inner lagoon and a surrounding barrier reef that defines the atoll structure. 
The Turneffe Atoll Marine Reserve (TAMR), which spans the entire atoll covers 1,471 km², and is divided into several management zones, 
including general use, conservation, preservation, spawning aggregation sites, and special management areas. 
TAMR plays a critical role in conserving biodiversity and sustaining the livelihoods of communities that rely on its resources. 
The reef system provides coastal protection from extreme weather events (Fedler, 2011), 
supports habitats for a wide range of marine species, and sustains key economic activities such as commercial and recreational fishing, SCUBA diving, and tourism.\

### Spawning Aggregations Monitoring

Monitoring spawning aggregations (SPAGs) at Turneffe Atoll Marine Reserve is critically important for sustaining Belize’s reef fisheries and ensuring long-term 
ecosystem resilience. Turneffe hosts several historically significant aggregation sites, including Maugre Caye, Dog Flea Caye, and Caye Bokel, where key commercial 
species such as Nassau grouper, snappers, and jacks gather to reproduce. These events make populations especially vulnerable to overfishing, as past declines across 
Belize have shown that unchecked exploitation can collapse entire aggregations and diminish national fishery yields. Recent monitoring has demonstrated that robust, 
standardized surveys, including underwater counts, laser sizing, and acoustic monitoring, not only provide fishery-independent data on abundance, size structure, 
and spawning behavior but also strengthen Belize’s adaptive multispecies finfish management plan. By tracking population health and reproductive success over time, 
SPAG monitoring at Turneffe safeguards critical breeding grounds, supports food security and tourism, and ensures that management interventions are guided by science 
to prevent overexploitation and promote recovery of endangered species such as the Nassau grouper. 

Belize’s finfish management basket approach is a practical, ecosystem-based system that groups similar reef fish species into “management baskets” 
so they can be regulated collectively rather than through species-specific rules. Because Belize’s commercial finfish fishery is multispecies, 
with fishers catching a mix of snappers, groupers, jacks, grunts, and others on the same trip, the basket system streamlines management by 
applying shared regulations, such as size limits, seasonal closures, catch monitoring, and effort controls, to each group. Indicator species 
within each basket provide biological signals that guide adaptive decisions over time, including when to tighten or relax rules. Designed to be used 
alongside Belize’s broader adaptive finfish management plan, the basket approach makes enforcement more feasible, reduces species misreporting, and 
supports sustainability by managing ecological groups together rather than risking serial depletion of individual species.\


## Methods

SPAGs data were collected at Turneffe Atoll 
Marine Reserve (TAMR) (Figure 1). 
The survey period for this report’s dataset extended 
from `r study_start` to `r study_end` at TAMR.


```{r figure1, echo = FALSE, fig.width = 7, fig.height = 7}
# Create map for Figure 1 ---------------------------
df_map <- df |>
  select(Site, Latitude, Longitude) |>
  distinct() |>
  na.omit()
if (study_year >= 2024) {
generate_map(df_map, "Latitude", "Longitude", "Site")
} else{
  generate_map_historic(df_map, "Latitude", "Longitude", "Site")
}
```

*Figure 1.* Map of Turneffe Atoll Marine Reserve zones and ecosystems. 
Shapefiles for zones belong to the Belize Fisheries Department (Belize Geomatics 2022). 
Shapefiles for the base map and ecosystems come from the publicly available Spatial Data 
Warehouse for Belize (Meerman 2013, Meerman 2017).
Waypoints for SPAG dives recorded in `r study_timeframe` are labelled on the map.\

Dive surveys were conducted by trained dive teams that followed standardized survey protocol at 
each Turneffe Atoll SPAG site. Dive timings were chosen to align with 
anticipated spawning events, which are associated with the full moon. 
For each dive, the GPS coordinates of the dive, start and end time of the dive, 
surface conditions, and underwater conditions were recorded. 
Next, species counts were taken, with observed fish species being counted and categorized into 
standardized size classes where it was possible to do so accurately. Otherwise, 
raw counts were simply taken without size differentiation. 
Behaviors indicative of spawning activity, including grouping, fighting, 
color changes, bite wounds, gravid individuals, courtship, and observed spawning, were also recorded. 

During the visual counts, Nassau groupers and other select fish species were additionally measured 
using laser sizing methodology, to acquire a more accurate measurement of length. The laser 
system comprised of two waterproof, dive-rated red lasers which were attached to 
a metal camera mounting frame. The lasers were configured to be set parallel to each other and aligned, 
with an exactly 12cm separation and a camera affixed to the top of the frame. 
During laser sizing, the lasers followed the 
lateral line of the fish as they swam by at approximately 5 to 6 meters away, 
and their movements were recorded via video. After the fieldwork, the videos were 
reviewed and the laser points were used to establish the scale for extrapolating the total lengths 
of the target fish. 

For a complete, detailed description of the methodology, please refer to the 
Reef Fish Spawning Aggregation Monitoring Protocol for the Meso-American Reef and the Wider Caribbean, 
Version 2.0 (2004).

This report, including text, figures, and tables, was generated using the 
Turneffe Reef-Monitoring Data Reporting Tool (TASA 2025, version `r params$release`), an R Shiny app which takes 
standardized reef monitoring data, validates the dataset, and creates a shareable output. \

## Results

```{r df, echo = FALSE, fig.width = 7, fig.height = 7}
# Create merged df for results ---------------------------
df_spec <- params$datafile[[2]]
df_laser <- params$datafile[[3]]
df_fish <- params$datafile[[4]]
df_spec_merged <- df_spec |>
  left_join(df, by = c("Season", "Dive")) |>
  filter(Site != "" & !is.na(Site)) |>
  left_join(df_fish, by = c("Species English Name" = "Common Name")) |>
  left_join(df_fish,   by = c("Species English Name" = "Alternative Common Name")) |>
  filter((`Scientific Name.x` != "" & !is.na(`Scientific Name.x`)) | (`Scientific Name.y` != "" & !is.na(`Scientific Name.y`)))
df_laser_merged <- df_laser |>
  left_join(df, by = c("Season", "Dive"))  |>
  filter(`Team Leader` != "" & !is.na(`Team Leader`)) 

```

```{r table1_prep, echo = FALSE, fig.width = 7, fig.height = 7}
table1_separate <- df_spec_merged |>
  group_by(Site, Month) |>
  mutate(`Total Count` = as.numeric(`Total Count`)) |>
  summarise(
    Fish = sum(`Total Count`, na.omit = TRUE),
    Species = length(unique(`Species English Name`)),
    Dives = length(unique(Dive))
    )
table1_overall <- df_spec_merged |>
  mutate(Site = "Overall", Month = "Overall") |>
  group_by(Site, Month) |>
  mutate(`Total Count` = as.numeric(`Total Count`)) |>
  summarise(
    Fish = sum(`Total Count`, na.omit = TRUE),
    Species = length(unique(`Species English Name`)),
    Dives = length(unique(Dive))
    )
table1 <- bind_rows(table1_separate, table1_overall)
total_fish <- format(table1_overall$Fish, big.mark = ",", scientific = FALSE)
total_fish_num <- sum(as.numeric(table1_overall$Fish), na.rm = TRUE)
total_species <- table1_overall$Species
total_sites <- nrow(table1_separate)
total_dives <- table1_overall$Dives
total_mc <- format(filter(table1_separate, Site %in% c("Mauger Caye", "Maugre Caye"))$Fish, big.mark = ",", scientific = FALSE)
total_cb <- format(filter(table1_separate, Site %in% c("Caye Bokel", "Bokel"))$Fish, big.mark = ",", scientific = FALSE)
total_df <- format(filter(table1_separate, Site %in% c("Dog Flea", "Dog Flea Caye"))$Fish, big.mark = ",", scientific = FALSE)
```

```{r table2_prep, echo = FALSE, fig.width = 7, fig.height = 7}
table2 <- df_spec_merged |>
mutate( Species = `Species English Name`) |>
  group_by(Species) |>
  mutate(`Total Count` = as.numeric(`Total Count`)) |>
  summarise(
    Count = sum(`Total Count`, na.omit = TRUE),
    Proportion = round(Count/total_fish_num, 2),
    `Mauger Caye Count` = sum(`Total Count`[Site %in% c("Mauger Caye", "Maugre Caye")], na.rm = TRUE),
    `Caye Bokel Count` = sum(`Total Count`[Site %in% c("Caye Bokel", "Bokel Caye")], na.rm = TRUE),
    `Dog Flea Caye Count` = sum(`Total Count`[Site %in% c("Dog Flea Caye", "Dog Flea")], na.rm = TRUE)
  ) |>
  arrange(desc(Count)) |>
  slice_head(n = 10)
species_1 <- table2$Species[1]
count_1 <- format(table2$Count[1], scientific = FALSE)
prop_1 <- table2$Proportion[1]*100
species_2 <- table2$Species[2]
count_2 <- format(table2$Count[2], scientific = FALSE)
prop_2 <- table2$Proportion[2]*100
species_3 <- table2$Species[3]
count_3 <- format(table2$Count[3], scientific = FALSE)
prop_3 <- table2$Proportion[3]*100
families <- df_spec_merged %>%
  group_by(Family.x) %>%
  summarise(Count = sum(as.numeric(`Total Count`), na.rm = TRUE))
most_family <- families$`Family.x`[which.max(families$Count)]
```


In total, `r total_fish` fish of `r total_species` unique species were observed in 
`r study_timeframe` across `r total_sites` sites and `r total_dives` dives (Table 1; Figure 2). 
This included `r total_mc` fish at Mauger Caye, `r total_cb` fish at Caye Bokel, 
and `r total_df` fish at Dog Flea Caye (Table 1). 
The most observed fish species were `r species_1` (`r count_1` individuals; `r prop_1`%), 
`r species_2` (`r count_2` individuals; `r prop_2`%), 
and `r species_3` (`r count_3` individuals; `r prop_3`%) (Table 2). 
The most observed fish family was `r most_family` (Figure 3).\


**Table 1.** Summary of SPAG monitoring by site/month and overall, including total fish observed, 
number of unique species observed, and number of survey dives. 
Data were collected using SPAG data from Turneffe Atoll Marine Reserve, `r study_timeframe`.\


```{r table1, echo = FALSE, fig.width = 7, fig.height = 7}
as.data.frame(table1)
```


<br>


```{r figure2, echo = FALSE, fig.width = 7, fig.height = 8.5}
df_fig2 <- df_spec_merged %>%
  mutate(`Total Count` = as.numeric(`Total Count`)) %>%
  group_by(Site, Month, `Species English Name`) %>%
  summarise(Count = sum(`Total Count`, na.rm = TRUE))  %>%
  filter(Count > 0) %>%
  mutate(Panel = case_when(
    Site == "Mauger Caye" ~ "A. Mauger Caye",
    Site == "Maugre Caye" ~ "A. Mauger Caye",
    Site == "Caye Bokel" ~ "B. Caye Bokel",
    Site == "Dog Flea Caye" ~ "C. Dog Flea Caye",
    Site == "Dog Flea" ~ "C. Dog Flea Caye"
    )
    )

ggplot(df_fig2, aes(x = `Species English Name`, y = Count, fill = Month)) +
  geom_col(position = position_dodge(width = 0.9), color = "black") + 
  scale_y_log10(
    breaks = 10^(0:6),
    labels = scales::comma_format(),
    minor_breaks = unlist(lapply(0:6, function(p) (1:9) * 10^p))
  ) +
  annotation_logticks(sides = "l") +
  labs(x = "Species", y = "Count") +
  theme_custom +
  scale_fill_manual(values = palette[2:6]) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    strip.background = element_blank(),
    strip.text = element_text(size = 18, hjust = 0, margin = margin(0, 0, 5, 0))
    ) +
  facet_wrap(~Panel, nrow = 3)


```

*Figure 2.* Bar plot of observed fish species counts in Mauger Caye (A), 
Caye Bokel (B), and Dog Flea Caye (C), 
recorded during spawning aggregations at Turneffe 
Atoll Marine Reserve, `r study_timeframe`.\


<br>


**Table 2.** Summary of SPAG monitoring by species, including how many of that fish were observed, 
the proportion of overall fish that were that species, 
and the number of that fish found at Mauger Caye, Caye Bokel, and Dog Flea Caye individually. 
Data were collected using SPAG data from Turneffe Atoll Marine Reserve, `r study_timeframe`.\

```{r table2, echo = FALSE, fig.width = 7, fig.height = 7}
table2
```


<br>


```{r figure3, echo = FALSE, fig.width = 7, fig.height = 8.5}
df_fig3 <- df_spec_merged %>%
  group_by(Site, Family.x) %>%
  summarise(Count = sum(as.numeric(`Total Count`), na.rm = TRUE)) %>%
  filter(Count > 0) %>%
  mutate(Panel = case_when(
    Site == "Mauger Caye" ~ "A.",
    Site == "Maugre Caye" ~ "A.",
    Site == "Caye Bokel" ~ "B.",
    Site == "Dog Flea Caye" ~ "C.",
    Site == "Dog Flea" ~ "C."
    )
    )

ggplot(df_fig3, aes(x = Family.x, y = Count, fill = Site)) +
  geom_col(position = position_dodge(width = 0.9), color = "black") + 
  scale_y_log10(
    breaks = 10^(0:6),
    labels = scales::comma_format(),
    minor_breaks = unlist(lapply(0:6, function(p) (1:9) * 10^p))
  ) +
  annotation_logticks(sides = "l") +
  labs(x = "Fish Family", y = "Count") +
  theme_custom +
  scale_fill_manual(values = palette[2:6]) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    strip.background = element_blank(),
    strip.text = element_text(size = 18, hjust = 0, margin = margin(0, 0, 5, 0))
    ) +
  facet_wrap(~Panel, nrow = 3)

```

*Figure 3.* Bar plot of observed fish family counts in Mauger Caye (A), 
Caye Bokel (B), and Dog Flea Caye (C), 
recorded during spawning aggregations at Turneffe 
Atoll Marine Reserve, `r study_timeframe`.\


<br>


```{r figure4_prep, echo = FALSE, fig.width = 7, fig.height = 4.5}
df_fig4 <- df_spec_merged %>%
  select(
  `Species English Name`, `10-20 cm`,	`21-30 cm`,	`31-40 cm`,	`41-50 cm`,	
  `51-60 cm`,	`61-70 cm`,	`71-80 cm`, `81-90 cm`,	`91-100 cm`,	`101-110 cm`,	
  `111-120 cm`,	`121-130 cm`,	`> 130 cm`
  ) %>%
  mutate(across(-`Species English Name`, as.numeric)) %>%
  pivot_longer(
    cols = c(`10-20 cm`,	`21-30 cm`,	`31-40 cm`,	`41-50 cm`,	
  `51-60 cm`,	`61-70 cm`,	`71-80 cm`, `81-90 cm`,	`91-100 cm`,	`101-110 cm`,	
  `111-120 cm`,	`121-130 cm`,	`> 130 cm`),
  names_to = "Class", values_to = "Number"
  ) %>%
  filter(!is.na(Number) & Number > 0)%>%
  uncount(Number)  %>%
  mutate(
    Class = case_when(
      Class == "10-20 cm"  ~ 15,
      Class == "21-30 cm"  ~ 25,
      Class == "31-40 cm"  ~ 35,
      Class == "41-50 cm"  ~ 45,
      Class == "51-60 cm"  ~ 55,
      Class == "61-70 cm"  ~ 65,
      Class == "71-80 cm"  ~ 75,
      Class == "81-90 cm"  ~ 85,
      Class == "91-100 cm" ~ 95,
      Class == "101-110 cm"~ 105,
      Class == "111-120 cm"~ 115,
      Class == "121-130 cm"~ 125,
      Class == "> 130 cm"  ~ 135
    )
  ) %>%
  add_count(`Species English Name`, name = "Total") %>%
  filter(Total >= 10)  
fig4 <- ggplot(df_fig4, aes(x = `Species English Name`, y = Class)) +
  geom_violin()+
  theme_custom +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  xlab("Species") +
  ylab("Size Class") +
  scale_y_continuous(
    breaks = c(15, 25, 35, 45, 55, 65, 75, 85, 95, 105, 115, 125, 135),
    labels = c("10-20 cm", "21-30 cm", "31-40 cm", "41-50 cm",
               "51-60 cm", "61-70 cm", "71-80 cm", "81-90 cm",
               "91-100 cm", "101-110 cm", "111-120 cm", "121-130 cm",
               "> 130 cm")
  )
df_spec_merged <- df_spec_merged %>%
  mutate(across(c(`10-20 cm`, `21-30 cm`, `31-40 cm`, `41-50 cm`,
                  `51-60 cm`, `61-70 cm`, `71-80 cm`, `81-90 cm`,
                  `91-100 cm`, `101-110 cm`, `111-120 cm`, `121-130 cm`,
                  `> 130 cm`), as.numeric))
total_visuals <- sum(df_spec_merged$`10-20 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`21-30 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`31-40 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`41-50 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`51-60 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`61-70 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`71-80 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`81-90 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`91-100 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`101-110 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`111-120 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`121-130 cm`, na.rm = TRUE) +
  sum(df_spec_merged$`> 130 cm`, na.rm = TRUE) 
total_visuals <- format(total_visuals, big.mark = ",", scientific = FALSE)

```



```{r figure5_prep, echo = FALSE, fig.width = 7, fig.height = 6}
df_fig5_prelim <- df_laser_merged %>%
  mutate(`Fish Measurement (cm)` = as.numeric(`Fish Measurement (cm)`))
top_species <- df_fig5_prelim %>%
  count(Species) %>%
  arrange(desc(n)) %>%
  slice_head(n = 5) %>%
  pull(Species)
df_fig5 <- df_fig5_prelim %>%
  filter(Species %in% top_species)
df_fig5_mc <- df_fig5 %>%
  filter(Site.x %in% c("Mauger Caye", "Maugre Caye")) 
df_fig5_cb <- df_fig5 %>%
  filter(Site.x %in% c("Caye Bokel", "Bokel")) 
df_fig5_df <- df_fig5 %>%
  filter(Site.x %in% c("Dog Flea", "Dog Flea Caye")) 
palette_named <- setNames(palette[seq_along(top_species)], top_species)
fix_levels <- function(df, levels) {
  df %>% mutate(Species = factor(as.character(Species), levels = levels))
}
df_fig5 <- fix_levels(df_fig5, top_species)
df_fig5_mc <- fix_levels(df_fig5_mc, top_species)
df_fig5_cb <- fix_levels(df_fig5_cb, top_species)
df_fig5_df <- fix_levels(df_fig5_df, top_species)
plot_or_message <- function(data, site_name, palette, title) {
  has_data <- any(!is.na(data$`Fish Measurement (cm)`))
  if (!has_data) {
    ggplot() +
      annotate("text", x = 0.5, y = 0.5,
               label = paste("No data for", site_name),
               size = 5, fontface = "italic", color = "grey40") +
      theme_void() + theme(plot.title = element_text(size = 18, margin = margin(0, 0, 5, 0))) + 
      labs(title = title)
  } else {
    ggplot(data, aes(x = `Fish Measurement (cm)`, fill = Species)) +
      geom_histogram(binwidth = 1, color = "black", position = "identity") +
      theme_custom +
      theme(
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 9),
        legend.key.size = unit(0.4, "cm")
      ) +
      ylab("Count") +
      labs(title = title) +
      scale_x_continuous(breaks = seq(0, 120, by = 5)) +
      scale_fill_manual(values = palette)
  }
}
fig5A <- plot_or_message(df_fig5, "All Sites", palette_named, "A. Overall")
fig5B <- plot_or_message(df_fig5_mc, "Mauger Caye", palette_named, "B. Mauger Caye")
fig5C <- plot_or_message(df_fig5_cb, "Caye Bokel", palette_named, "C. Caye Bokel")
fig5D <- plot_or_message(df_fig5_df, "Dog Flea Caye", palette_named, "D. Dog Flea Caye")
fig5 <- ggarrange(fig5A, fig5B, fig5C, fig5D, nrow = 4, ncol = 1)
total_lasers_df <-  df_laser_merged %>%
  mutate(`Fish Measurement (cm)` = as.numeric(`Fish Measurement (cm)`)) %>%
  filter(`Fish Measurement (cm)`>= 0)
total_lasers <- nrow(total_lasers_df)
nassau_size <- round(mean(filter(df_fig5_prelim, Species == "Nassau Grouper")$`Fish Measurement (cm)`, na.rm = TRUE), 2)
```


```{r figure6_prep, echo = FALSE, fig.width = 7, fig.height = 4.5}
df_fig6 <- df_spec_merged %>%
  select(
    `Species English Name`, Site,
    `Grouping (1=yes)`, `Fighting (1=yes)`, `Color Changes (1=yes)`,
    `Bite Wounds (1=yes)`, `Gravid (1=yes)`, `Courtship (1=yes)`, `Spawning (1=yes)`
  ) %>%
  mutate(across(
    c(`Grouping (1=yes)`, `Fighting (1=yes)`, `Color Changes (1=yes)`,
      `Bite Wounds (1=yes)`, `Gravid (1=yes)`, `Courtship (1=yes)`, `Spawning (1=yes)`),
    as.numeric
  )) %>%
  pivot_longer(
    cols = c(`Grouping (1=yes)`, `Fighting (1=yes)`, `Color Changes (1=yes)`,
             `Bite Wounds (1=yes)`, `Gravid (1=yes)`, `Courtship (1=yes)`,
             `Spawning (1=yes)`),
    names_to = "Behavior", values_to = "Number"
  ) %>%
  group_by(Site, Behavior) %>%
  summarise(Count = sum(Number, na.rm = TRUE), .groups = "drop")%>%
  mutate(Behavior = str_remove(Behavior, " \\(1=yes\\)"))

fig6 <- ggplot(df_fig6, aes(x = Behavior, y = Site, fill = Count)) +
  geom_tile() +
    scale_fill_gradient(low = "white", high = palette[2]) +
  theme_custom
behaviors <- combine_words(unique(df_fig6$Behavior))
```


`r total_visuals` fish were measured using visual surveys, 
and `r total_lasers` fish were measured using laser methodology (Figure 4; Figure 5). 
The average laser-measured size of Nassau Grouper was `r nassau_size`cm (Figure 5; Table 3). 
Fish spawning behaviors observed included `r behaviors` (Figure 6).\


```{r figure4, echo = FALSE, fig.width = 7, fig.height = 4.5}
fig4
```



*Figure 4.* Violin plot of recorded size classes for fish, 
recorded during spawning aggregations visual surveys at Turneffe 
Atoll Marine Reserve, `r study_timeframe`. Fish species with fewer than 10 
observations of size class were excluded, and kernel densities were 
calculated using the midpoints of size classes.\


<br>


```{r figure5, echo = FALSE, fig.width = 7, fig.height = 9}
fig5
```


*Figure 5.* Length-frequency distributions of key fish, overall (A), at Mauger Caye (B), 
at Caye Bokel (C), and at Dog Flea Caye (D), 
recorded during spawning aggregations laser sizing at Turneffe 
Atoll Marine Reserve, `r study_timeframe`. Only the five fish species with the 
most laser sizing data overall are shown. \


**Table 3.** Summary of laser sizing by species and site, including the 
average fish length (cm) for the top 10 most measured species as well as the corresponding 
fish basket number, based on the United Nation Conference on Trade and Development (UNCTD, 2022). 
A basket of 0 means the fish was not assigned a basket, and a basket of NA means that the basket is 
unknown based on the common name provided. 
Data were collected using SPAG data from Turneffe Atoll Marine Reserve, `r study_timeframe`.\


```{r table3, echo = FALSE, fig.width = 7, fig.height = 7}

df_table3 <- df_laser_merged %>%
  mutate(`Fish Measurement (cm)` = as.numeric(`Fish Measurement (cm)`)) |>
  left_join(df_fish, by = c("Species" = "Common Name"))
top_species <- df_table3 %>%
  filter(!is.na(Species) & Species != "∅") %>%
  count(Species) %>%
  arrange(desc(n)) %>%
  slice_head(n = 10) %>%
  pull(Species)
df_table3 <- df_table3 %>%
  filter(Species %in% top_species) %>%
  ungroup() %>%
  mutate(Site = Site.x) 
df_table3_overall <- df_table3 %>%
  mutate(Site = "Overall") %>%
  group_by(Site, Species, Basket) %>%
  summarise(`Average Fish Length (cm)` = round(mean(`Fish Measurement (cm)`, na.rm = TRUE), 2), .groups = "drop")
df_table3 <- df_table3 %>%
  group_by(Site, Species, Basket) %>%
  summarise(`Average Fish Length (cm)` = round(mean(`Fish Measurement (cm)`, na.rm = TRUE), 2), .groups = "drop")
df_table3 <- bind_rows(df_table3, df_table3_overall)
df_table3_wide <- df_table3 %>%
  mutate(`Average Fish Length (cm)` = as.character(`Average Fish Length (cm)`)) %>%
    pivot_wider(
    names_from = Site, 
    values_from = `Average Fish Length (cm)`,
    values_fill = "-",
    names_prefix = "Length (cm) - ")
as.data.frame(df_table3_wide)
```



<br>


```{r figure6, echo = FALSE, fig.width = 7, fig.height = 4.5}
fig6

```

*Figure 6.* Tile plot of observed fish spawning behaviors, recorded during spawning aggregations 
visual surveys at Turneffe Atoll Marine Reserve, `r study_timeframe`.\


<br>


## Conclusion

By summarizing and visualizing the SPAG data from `r study_timeframe`, 
researchers, policy-makers, and other stakeholders are better able to interpret and use the dataset. 
This report supports the aims of the SPAG data collection by offering a more understandable view 
of the data itself, supporting future efforts to create recommendations on enforcement, monitoring, 
education, outreach, and regulations to ensure the long-term sustainability of the TAMR fishery while safeguarding the 
ecological value of the atoll.\


## Acknowledgments

Thank you to all team leaders, data collectors, and captains who participated in this project.\


## Report Metadata

**Date Generated:** `r format(Sys.time(), '%Y-%m-%d')` \
**Source Data:** `r params$datafile_name` \
**Generated by:** `r params$user_name`\
**App Version:** `r params$release`\


## Literature Cited

Fedler, A. J. (2011). The Economic Value of Turneffe Atoll (Full Report). Turneffe Atoll Trust. http://www.turneffeatollmarinereserve.org/app/webroot/userfiles/214/File/Turneffe%20Atoll%20Valuation%20Study%20PDF%20-%20Final%20Report.pdf

Reef Fish Spawning Aggregation Monitoring Protocol for the Meso-American Reef and the Wider Caribbean, Version 2.0. (2004). https://reefresilience.org/pdf/Spawning_Aggregation_Monitoring_Protocol_4July2004.pdf

Stoddart, D. R. (1962). Three Caribbean atolls: Turneffe Islands, Lighthouse Reef and Glover’s Reef,  British Honduras. Atoll Research Bulletin, 87, 1–151.

United Nations Conference on Trade and Development. (2022). Towards a Climate Resilient Multispecies Finfish Management Plan for Belize. United Nations.

Van Overzee, H. M. J., & Rijnsdorp, A. D. (2015). Effects of fishing during the spawning period: Implications for sustainable management. Reviews in Fish Biology and Fisheries, 25(1), 65–83. https://doi.org/10.1007/s11160-014-9370-x
