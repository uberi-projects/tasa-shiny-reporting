---
output:
  officedown::rdocx_document:
    reference_docx: report_template.docx
    tables:
      style: table_template
params:
  user_name: "Unknown"
  datafile: pressure
  datafile_name: "Unknown"
  fisher_1per_timeframe: "Annual"
  fisher_1per_year_selection: "None"
  fisher_1per_period_selection: "None"
  fisher_1per_lobster_season_selection: "None" 
  fisher_1per_conch_season_selection: "None" 
  fisher_1per_finfish_season_selection: "None"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

# Load packages ---------------------------
library(knitr)
library(officedown)
library(rmarkdown)
library(tidyverse)
library(ggpubr)

# Source code  ---------------------------
source("theme.r")
source("map.r")

# Determine year or season  ---------------------------
timeframe <- params$fisher_1per_timeframe

# Filter to year or season  ---------------------------
df <- params$datafile[[1]]
df$`Waypoint Date` <- as.Date(df$`Waypoint Date`)
if (timeframe == "Annual" && as.character(params$fisher_1per_year_selection) != "None") {
  df <- df |>
    filter(format(`Waypoint Date`, "%Y") == params$fisher_1per_year_selection)
} else if (timeframe == "Seasonal" && as.character(params$fisher_1per_lobster_season_selection) != "None") {
  season_years <- unlist(strsplit(params$fisher_1per_lobster_season_selection, "-"))
  start_date <- as.Date(paste0(season_years[1], "-07-01"))
  end_date <- as.Date(paste0(season_years[2], "-02-28"))
  df <- df |>
    filter(`Waypoint Date` >= start_date, `Waypoint Date` <= end_date)
}

# Add month column  ---------------------------
df$Month <- format(df$`Waypoint Date`, "%b %Y")

# Define study timeframe ---------------------------
study_start <- min(df$`Waypoint Date`, na.rm = TRUE)
study_end <- max(df$`Waypoint Date`, na.rm = TRUE)
if (timeframe == "Annual") {
  study_timeframe <- unique(format(df$`Waypoint Date`, "%Y"))[1]
} else if (timeframe == "Seasonal") {
  study_timeframe <- paste0(format(study_start, "%Y"), "-", format(study_end, "%Y"))
}
```

# Turneffe Atoll Fisher Catch Lobster `r timeframe` Dataset Report: `r study_timeframe`


Turneffe Atoll Sustainability Association (TASA)


**Date Generated:** `r format(Sys.time(), '%Y-%m-%d')` \
**Source Data:** `r params$datafile_name` \
**Generated by:** `r params$user_name`\

***


The marine resources and biodiversity abundant in coral reef ecosystems support the 
livelihoods of coastal communities, and provide economic opportunities that can be 
sustainable given attentive management and enforcement. 
Monitoring the activities and harvests of local fishers is important for 
understanding ecosystem productivity, assessing stock sustainability, 
and informing effective management decisions. 
This report presents `r tolower(timeframe)` findings from fishery-dependent monitoring of Caribbean spiny 
lobster (Panulirus argus) at Turneffe Atoll Marine Reserve (TAMR) from `r study_timeframe`. 
Data were recorded directly by fishermen using SMART technology through a data collection 
package designed by TASA. This report aims to summarize and visualize the Fisher 
Lobster Catch dataset from `r study_timeframe` to facilitate data interpretation and support 
management decisions by TASA staff, collaborators, and stakeholders.\


## Background

### Turneffe Atoll Marine Reserve

Turneffe Atoll is the largest atoll in Belize, spanning mangrove and littoral forest cayes, seagrass beds, and coral reef ecosystems (Stoddart, 1962). 
It features an inner lagoon as well as an outer reef that encircles the atoll. 
The Turneffe Atoll Marine Reserve (TAMR), which encompasses the entire atoll, covers 1,471 km² and includes multiple management zones, such as general use, conservation, preservation, and spawning aggregation zones, as well as special management areas. 
TAMR plays a valuable role in supporting biodiversity and sustaining the communities that depend on its resources. 
Its reef provides coastal protection from extreme weather events (Fedler, 2011), serves as a habitat for diverse marine species, and supports economic activities such as commercial and recreational fishing, guided diving, and tourism.\

### Fisher Catch Project

Background on reef monitoring dataset type \


### Caribbean Spiny Lobsters

Caribbean spiny lobsters (Panulirus argus) are brown-grey striped malacostracans, 
which can grow to around 60cm long, and have spines covering their shells instead of the 
large pinching claws of other lobsters (Holthuis, 1991). Spotted spiny lobster 
(Panulirus guttatus) are smaller than Caribbean spiny lobsters, with more distinct 
spots and shorter antennae. In Belize, the lobster fishery is the most important fishery 
in the country. Lobsters are caught using freediving and a hook stick, trapezoidal-shaped 
lobster traps placed in shallow sandy areas, or casitas (shade cloths) that act as a lure 
for lobsters which are then caught with a hook stick, snare, or a net bag (UNCTAD 2020). 
Regulations for Caribbean spiny lobster from the BFD include that no person shall fish 
moutling lobster or lobster with eggs, that fished lobster have minimum carapace length 
of 3-inches and minimum tail weight of 4-ounces, and that fishers adhere to the prescribed 
open season. Closed season is March 1st to June 30th for lobster (Belize Fisheries 
Department accessed 2025-b). Tar spots on female lobsters indicate recent mating, and 
females with eggs (‘berried’ females) indicate reproductive success. Monitoring sex ratio 
and presence of reproductive indicators is key for this species./


## Methods

Fisher catch data were collected at Turneffe Atoll 
Marine Reserve (TAMR) (Figure 1). 
The survey period for this report’s dataset extended 
from `r study_start` to `r study_end` at TAMR.

Fishermen were selected [process of selecting fishermen 
for the project]

Data on _____ were entered by fishermen using SMART 
technology through a data collection package 
designed by TASA. They [process of entering data by 
fishermen into SMART]

This report, including text, figures, and tables, was generated using the 
Turneffe Reef-Monitoring Data Reporting Tool (TASA 2025), an R Shiny app which takes 
standardized reef monitoring data, validates the dataset, and creates a shareable output. \


```{r figure1, echo = FALSE, fig.width = 7, fig.height = 7}
# Create map for Figure 1 ---------------------------
df_map <- df |>
  select(`Waypoint ID`, Y, X) |>
  distinct()
if (length(unique(df$`Waypoint ID`)) < 5) {
  generate_map(df_map, "Y", "X", "Waypoint ID")
} else {
  generate_map_nolabels(df_map, "Y", "X", "Waypoint ID")
}
```


*Figure 1.* Map of Turneffe Atoll Marine Reserve zones and ecosystems. 
Shapefiles for zones belong to the Belize Fisheries Department (Belize Geomatics 2022). 
Shapefiles for the base map and ecosystems come from the publicly available Spatial Data 
Warehouse for Belize (Meerman 2013, Meerman 2017).
Waypoints recorded in `r study_timeframe` are labelled on the map.\

 
## Results


```{r table1_prep, echo = FALSE, include = FALSE}
# Create df for Table 1 ---------------------------
df_events_overall <- df %>%
  select(`Waypoint ID`, `Hours Fished`, `Total Lbs of Catch`) %>%
  distinct() %>%
  summarize(
    Hours = sum(`Hours Fished`, na.rm = TRUE),
    `Catch (lb)` = sum(`Total Lbs of Catch`, na.rm = TRUE)
  ) %>%
  mutate(Month = "Overall")
df_table1_overall <- df %>%
  summarize(
    Fishers = n_distinct(`Fishers Name`),
    Lobster = n(),
    Events = n_distinct(`Waypoint ID`)
  ) %>%
  mutate(Month = "Overall") %>%
  left_join(df_events_overall, by = "Month") %>%
  mutate(
    `CPUE (lb/hr)` = round(`Catch (lb)` / Hours, 1),
    `CPUE (#/hr)` = round(Lobster / Hours, 1)
  )
df_events <- df %>%
  mutate(
    Month = format(`Waypoint Date`, "%b %Y"),
    Month_sort = as.Date(format(`Waypoint Date`, "%Y-%m-01"))
  ) %>%
  select(Month, `Waypoint ID`, `Hours Fished`, `Total Lbs of Catch`) %>%
  distinct() %>%
  group_by(Month) %>%
  summarize(
    Hours = sum(`Hours Fished`, na.rm = TRUE),
    `Catch (lb)` = sum(`Total Lbs of Catch`, na.rm = TRUE)
  )
df_table1 <- df %>%
  mutate(
    Month = format(`Waypoint Date`, "%b %Y"),
    Month_sort = as.Date(format(`Waypoint Date`, "%Y-%m-01"))
  ) %>%
  group_by(Month, Month_sort) %>%
  summarize(
    Fishers = n_distinct(`Fishers Name`),
    Lobster = n(),
    Events = n_distinct(`Waypoint ID`)
  ) %>%
  left_join(df_events, by = "Month") %>%
  arrange(Month_sort) %>%
  select(-Month_sort) %>%
  mutate(
    `CPUE (lb/hr)` = round(`Catch (lb)` / Hours, 1),
    `CPUE (#/hr)` = round(Lobster / Hours, 1)
  ) %>%
  bind_rows(df_table1_overall)

# Prepare dynamic variables for Table 1 ---------------------------
total_fishers <- length(unique(df$`Fishers Name`))
total_lobsters <- df_table1_overall$Lobster
total_events <- df_table1_overall$Events
total_hours <- df_table1_overall$Hours
max_cpue_lb <- max(df_table1$`CPUE (lb/hr)`, na.rm = TRUE)
max_cpue_lb_month <- df_table1$Month[which.max(df_table1$`CPUE (lb/hr)`)]
min_cpue_lb <- min(df_table1$`CPUE (lb/hr)`, na.rm = TRUE)
min_cpue_lb_month <- df_table1$Month[which.min(df_table1$`CPUE (lb/hr)`)]
max_cpue_num <- max(df_table1$`CPUE (#/hr)`, na.rm = TRUE)
max_cpue_num_month <- df_table1$Month[which.max(df_table1$`CPUE (#/hr)`)]
min_cpue_num <- min(df_table1$`CPUE (#/hr)`, na.rm = TRUE)
min_cpue_num_month <- df_table1$Month[which.min(df_table1$`CPUE (#/hr)`)]
```


Between `r study_start` and `r study_end`, `r total_fishers` fishermen contributed data to the Caribbean 
spiny lobster SMART dataset. A total of `r total_lobsters` lobster were caught across `r total_events` 
fishing events, totalling `r total_hours` active fishing hours. 
The highest catch per unit effort (CPUE) 
in pounds per hour (lb/hr) occurred in `r max_cpue_lb_month` with `r max_cpue_lb`, whereas the lowest 
occurred in `r min_cpue_lb_month` with `r min_cpue_lb`. The highest CPUE in count 
per hour (#/hr) occurred in `r max_cpue_num_month` 
with `r max_cpue_num`, whereas the lowest was `r min_cpue_num_month` 
in `r min_cpue_num` (Table 1; Figure 1).\


**Table 1.** Summary of fishing effort and catch for each month, 
using SMART data from fishers at Turneffe Atoll Marine Reserve, `r study_timeframe`.\

```{r table1, echo = FALSE}
# show table
as.data.frame(df_table1)
```


```{r table2_prep, echo = FALSE, include = FALSE}
# Create df for Table 2 ---------------------------
df_table2_rows <- df %>%
  mutate(
    Month = format(`Waypoint Date`, "%b %Y"),
    Month_sort = as.Date(format(`Waypoint Date`, "%Y-%m-01"))
  ) %>%
  group_by(`Waypoint ID`) %>%
  summarize(
    Month = first(Month),
    Month_sort = first(Month_sort),
    Hours = first(`Hours Fished`),
    Catch_lb = first(`Total Lbs of Catch`),
    Lobster = n(),
    .groups = "drop"
  ) %>%
  mutate(
    `CPUE (lb/hr)` = ifelse(Hours > 0, Catch_lb / Hours, NA),
    `CPUE (#/hr)` = ifelse(Hours > 0, Lobster / Hours, NA)
  )
df_table2_lb_overall <- df_table2_rows %>%
  summarize(
    Mean = round(mean(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    Min = round(min(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    Q1 = round(quantile(`CPUE (lb/hr)`, 0.25, na.rm = TRUE), 1),
    Median = round(median(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    Q3 = round(quantile(`CPUE (lb/hr)`, 0.75, na.rm = TRUE), 1),
    Max = round(max(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    Var = round(var(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    SD = round(sd(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    .groups = "drop"
  ) %>%
  mutate(Month = "Overall")
df_table2_lb <- df_table2_rows %>%
  group_by(Month, Month_sort) %>%
  summarize(
    Mean = round(mean(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    Min = round(min(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    Q1 = round(quantile(`CPUE (lb/hr)`, 0.25, na.rm = TRUE), 1),
    Median = round(median(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    Q3 = round(quantile(`CPUE (lb/hr)`, 0.75, na.rm = TRUE), 1),
    Max = round(max(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    Var = round(var(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    SD = round(sd(`CPUE (lb/hr)`, na.rm = TRUE), 1),
    .groups = "drop"
  ) %>%
  arrange(Month_sort) %>%
  select(-Month_sort) %>%
  bind_rows(df_table2_lb_overall)

# Prepare dynamic variables for Table 2 ---------------------------
overall_mean <- df_table2_lb_overall$Mean
overall_median <- df_table2_lb_overall$Median
max_cpue_mean_lb <- max(df_table2_lb$Mean, na.rm = TRUE)
max_cpue_mean_lb_month <- df_table2_lb$Month[which.max(df_table2_lb$Mean)]
min_cpue_mean_lb <- min(df_table2_lb$Mean, na.rm = TRUE)
min_cpue_mean_lb_month <- df_table2_lb$Month[which.min(df_table2_lb$Mean)]
```


The CPUE of lobsters in lb/hr had a 
mean of `r overall_mean` and median of `r overall_median`, 
with the highest mean of `r max_cpue_mean_lb` being in `r max_cpue_mean_lb_month` 
and the lowest mean of `r min_cpue_mean_lb` being in `r min_cpue_mean_lb_month`. 
(Table 2; Figure 1).\


```{r table2, echo = FALSE}
# show table
as.data.frame(df_table2_lb)
```
